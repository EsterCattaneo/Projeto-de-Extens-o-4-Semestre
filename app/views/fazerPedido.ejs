<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doceria Doce Viver</title>
    <link href='https://fonts.googleapis.com/css?family=Oswald:300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles/navegation.css">
    <link rel="stylesheet" href="styles/footer.css">
    <link rel="stylesheet" href="styles/cardapio.css">
    <link rel="stylesheet" href="styles/pedido.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>

<body>

<%- include('menu-header') %>

<h1>Cardápio</h1>

<div>
    <label>Filtrar por categoria:</label>
    <select id="categoriaFiltro" onchange="aplicarFiltros()">
        <option value="todos">Todos</option>
        <option value="Salgados">Salgados</option>
        <option value="Doces">Doces</option>
        <option value="Bebidas">Bebidas</option>
        <option value="Vegana">Vegana</option>
        <!-- ...outras opções -->
    </select>

    <label>Ordenar por preço:</label>
        <select id="precoFiltro" onchange="aplicarFiltros()">
            <option value="crescente">Crescente</option>
            <option value="decrescente">Decrescente</option>
        </select>
    </label>
</div>

<div id="salgados" class="categoria-item">
    <h2>Salgados</h2>
    <table id="table-salgados">
    
        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Salgados"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>

                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>
<div id="doces" class="categoria-item">
    <h2>Doces</h2>
    <table id="table-doces">

        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Doces"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>
                </tr>

                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>
<div id="bebidas" class="categoria-item">
    <h2>Bebidas</h2>
    <table id="table-bebidas">

        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Bebidas"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>
                </tr>

                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>
<div id="vegana" class="categoria-item">
    <h2>Veganas</h2>
    <table id="table-veganos">
    
        <thead>
            <tr class="cabecalho">
                <th>Categoria</th>
                <th>Nome</th>
                <th>Detalhes</th>
                <th>Preço</th>
                <th>Adicione ao pedido</th>
            </tr>
        </thead>
        <tbody>
            <% menu.forEach(item => { %>
                <%if (item.categoria == "Vegana"){ %>
                
                <tr class="item">
                    <td data-categoria="<% item.categoria %>"><%= item.categoria %></td>
                    <td data-nome="<%= item.nome_item %>"><%= item.nome_item %></td>
                    <td data-detalhes="<% item.detalhes %>"><%= item.detalhes %></td>
                    <td name=<%= item.preco %>><%= item.preco %></td>
                    <td>
                        <button id="aumentar" onclick="aumentar(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">+</button>
                        <span class="btn-span" id="valor-<%=item.id%>" value="0">0</span>
                        <button id="diminuir" onclick="diminuir(<%=item.id%>, <%= item.preco %>, '<%= item.nome_item %>')">-</button>
                    </td>
                </tr>

                <% } %>
            <% }) %>
        </tbody>

    </table>
</div>

<br><br>
<div class="container">
    <p>Total: R$<span id="valor-total">0</span></p>
        
    <div style="display: none">
        <div class="container" id = "pedidos">
            
        </div>
    </div>

    <% if (user) { %> 
        <div class="content">
            <nav class="comprovante">
                <button class="btn open-modal" onclick="document.querySelector('.modal').classList.add('show')">Fechar comanda</button>
                
                <!-- Botão que expande/colapsa o conteúdo -->
                <input type="checkbox" id="toggle" class="collapse-checkbox">
                <label class="btn collapse-button" for="toggle">Gerar Comprovante</label>
        
                <!-- Botão de download que permanece visível -->
                <button class="btn" onclick="gerarPDF()">Download comprovante</button>
        
                <!-- Conteúdo colapsável -->
                <div class="collapse-content" id="comprovante-pdf">
                    <div class="card-comprovante">
                        <div class="content">
                            <h3>Doceria Doce Viver</h3>
                            <h4>Obrigado pelo seu pedido!</h4>
                            <p class="tracado-baixo">Resumo do pedido</p>
                            <div class="container">
                                <div class="container" id="pedidos-comanda"></div>
                                
                                <h3 class="tracado-cima">Total: R$<span id="valor-total-comanda">0</span></h3>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
              

    <% } else { %>
        <div class="content">
            <nav class="comprovante">
                <h4>Faça login para fechar o seu pedido!</h4>
                <a class="btn" href="/login">Entrar</a>
            </nav>
        </div>
    <% } %>
</div>
<br><br>

<div class="modal">
    <div class="modal-content">
      <button class="close" onclick="document.querySelector('.modal').classList.remove('show')">&times;</button>
      <h2>Comanda fechada com sucesso!</h2>
      <p>Clique em gerar comprovante ou fazer download para visualizar os itens do seu pedido!</p>
      <button class='btn' onclick="document.querySelector('.modal').classList.remove('show')">Fechar</button>
    </div>
</div>



<footer>
    <div class="footer-basic">
        <div class="social">
            <a href="https://www.instagram.com/doce_viver_sh/?igsh=d21oNHhyb253dmZv"><i class="icon ion-social-instagram"></i></a>
            <a href="https://api.whatsapp.com/send?phone=seu-numero-de-telefone"><i class="icon ion-social-whatsapp"></i></a>
            <a href="https://maps.app.goo.gl/xmEBu6z6M5VTdjGd9"><i class="fa fa-map-marker"></i></a>
        </div>
        <ul class="list-inline">
            <li class="list-inline-item"><a href="/">Início</a></li>
            <li class="list-inline-item"><a href="sobreNos">Sobre nós</a></li>
            <li class="list-inline-item"><a href="cardapio">Cardápio</a></li>
            <li class="list-inline-item"><a href="galeria">Galeria</a></li>
            <li class="list-inline-item"><a href="ifsp">IFSP</a></li>
            <li class="list-inline-item"><a href="fazerPedido">Faça seu pedido</a></li>
        </ul>
        <p class="copyright">Doce Viver © 2024</p>
    </div>
</footer>

<script>
    const items = Array.from(document.querySelectorAll('.item'));
    const categoria_items = Array.from(document.querySelectorAll('.categoria-item'));
    // const puppeteer = require('puppeteer');

    function aplicarFiltros() {
        const categoriaFiltro = document.getElementById('categoriaFiltro').value;
        const precoFiltro = document.getElementById('precoFiltro').value;

        // Filtra as categorias
        categoria_items.forEach(item => {
            const categoria = item.querySelector('h2').innerText;
            console.log(categoria);
            if (categoriaFiltro === 'todos' || categoria.includes(categoriaFiltro)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });

        // Seleciona a tabela correta com base na categoria
        const tabelaCategoria = document.querySelector(`#table-${categoriaFiltro.toLowerCase()}`);
        if (!tabelaCategoria) return; // Caso não haja tabela correspondente

        const linhas = Array.from(tabelaCategoria.querySelectorAll('.item'));

        // Ordena as linhas pelo preço conforme o filtro selecionado
        linhas.sort((a, b) => {
            const precoA = parseFloat(a.querySelector('td[name]').getAttribute('name'));
            const precoB = parseFloat(b.querySelector('td[name]').getAttribute('name'));

            return precoFiltro === 'crescente' ? precoA - precoB : precoB - precoA;
        });

        // Remove as linhas da tabela e insere na nova ordem
        const tbody = tabelaCategoria.querySelector('tbody');
        tbody.innerHTML = ''; // Limpa o tbody atual
        linhas.forEach(linha => tbody.appendChild(linha));
    }

    // Função para aumentar o valor
    function aumentar(id, preco, nome) {
        const valorElemento = document.getElementById("valor-" + id);
        newValor = parseInt(valorElemento.getAttribute("value")) + 1;
        valorElemento.textContent = newValor;
        valorElemento.setAttribute("value", newValor);
        calculaTotal(preco);
        adicionarNomeItem(nome, preco);
    }

    // Função para diminuir o valor
    function diminuir(id, preco, nome) {
        const valorElemento = document.getElementById("valor-" + id);
        newValor = parseInt(valorElemento.getAttribute("value")) - 1;
        if(newValor < 0){
            newValor = 0;
        }
        valorElemento.textContent = newValor;
        valorElemento.setAttribute("value", newValor);
        calculaTotal(-preco);
        removeNomeItem(nome, preco);
    }

    // Função para diminuir o valor
    function calculaTotal(valorPedido) {
        const valorElemento = document.getElementById("valor-total");
        const valorElementoComanda = document.getElementById("valor-total-comanda");
        newValor = parseFloat(valorElemento.textContent) + valorPedido;
        if(newValor < 0){
            newValor = 0;
        }
        valorElemento.textContent = newValor;
        valorElementoComanda.textContent = newValor;
    }

    function adicionarNomeItem(nome, preco){
        const valorElemento = document.getElementById("pedidos");
        const valorElementoComanda = document.getElementById("pedidos-comanda");
        valorElemento.innerHTML = valorElemento.innerHTML + "<p>" + nome + " (R$" + preco + ") </p>";
        valorElementoComanda.innerHTML = valorElementoComanda.innerHTML + "<p>" + nome + " (R$" + preco + ") </p>";
    }

    function removeNomeItem(nome, preco){
        const valorElemento = document.getElementById("pedidos");
        const valorElementoComanda = document.getElementById("pedidos-comanda");
        const textRemove = "<p>" + nome + " (R$" + preco + ") </p>";
        
        if(valorElemento.innerHTML.includes(textRemove)){
            valorElemento.innerHTML = valorElemento.innerHTML.replace(textRemove, '');
        }
        
        if(valorElementoComanda.innerHTML.includes(textRemove)){
            valorElementoComanda.innerHTML = valorElementoComanda.innerHTML.replace(textRemove, '');
        }

    }

    function gerarPDF() {
        let conteudo = "<style>.card-comprovante {display: block;width: 100%;background-color: #fff;border-radius: 6px;overflow: hidden;box-shadow: 0px 4px 6px rgba(0, 0, 0, .12);text-align: left;} .card-comprovante h4 {color: #F39562;} .tracado-baixo {border-bottom: 2px dotted #F39562;color: #F39562;padding-bottom: 15px;} .tracado-cima {border-top: 2px dotted #F39562;padding-top: 15px;} .image-comanda {height: 200px;overflow: hidden;} .image-comanda img {width: 100%;height: 100%;object-fit: cover;} .collapse-checkbox {display: none;} .collapse-button {display: inline-block;transition: background-color 0.3s;} .btn {display: inline-block;transition: background-color 0.3s;} .collapse-content {max-height: 0;overflow: hidden;transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;margin-top: 10px;} .collapse-checkbox:checked + .collapse-button + .btn + .collapse-content {max-height: 1000px;padding: 10px;} .card-comprovante {display: block;border: 1px solid #ddd;border-radius: 5px;background-color: #f8f9fa;padding: 10px;} .content h3, .content h4, .content p {margin: 10px 0;}</style>";
        conteudo = conteudo + document.getElementById("comprovante-pdf").innerHTML;
        const novaJanela = window.open('', '_blank', 'width=800,height=600');
        novaJanela.document.write(conteudo);
        novaJanela.document.close();
        novaJanela.print();
    }

</script>

</body>
</html>
